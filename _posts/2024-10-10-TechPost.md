---
layout: post
pagination: 
  enabled: true
type: tech
date: 2024-10-10 20:01
category: Blog
title: Unity HashSet Deserialize ì´ìŠˆ
subtitle: iOSì—ì„œ ë°œìƒí•˜ëŠ” HashSetì˜ ì—­ì§ë ¬í™” ì‹œ ë°œìƒí•˜ëŠ” ë¬¸ì œ
writer: KimYC1223
post-header: false
image: title.png
tags: [Unity]
draft : false
---

{% capture img_url %}/assets/blog/{{page.date | date: "%Y-%m-%d"}}-TechPost{% endcapture %}

ìµœê·¼ í”„ë¡œì íŠ¸ë¥¼ ì§„í–‰í•˜ë©´ì„œ, iOS ë¹Œë“œë¥¼ ì§„í–‰í–ˆëŠ”ë° ë¡œë”© Sceneì—ì„œ 

**ArgumentNullException: Value cannot be null** ì—ëŸ¬ê°€ ë‚˜ë©° ë„˜ì–´ê°€ì§€ ì•ŠëŠ” ê²ƒì„ í™•ì¸í–ˆë‹¤.

```
ArgumentNullException: Value cannot be null.
Parameter name: method
```

ì¢€ ë” ìì„¸í•˜ê²ŒëŠ” <span class="post-highlight">ArgumentNullException</span> ì´ ë°œìƒí•œ ê²ƒì´ì—ˆëŠ”ë°,

ì´ë¥¼ í•´ê²°í•˜ê¸° ìœ„í•œ ë°©ë²•ì„ ì°¾ì•„ë‚´ì–´ ë¸”ë¡œê·¸ì— ê³µìœ í•œë‹¤.

ë°”ë¡œ í•´ê²° ë°©ë²•ì´ ê¶ê¸ˆí•œ ì‚¬ëŒì€ ì•„ë˜ **í•´ê²° ë°©ë²•** ì±•í„°ë¥¼ ì°¸ê³ í•˜ì‹œê¸¸!

<br><br>

---

# ğŸ”· ë¬¸ì œ ë°œê²¬

ì–´ëŠë‚  iOSì—ì„œ ë¹Œë“œë¥¼ ì§„í–‰í•˜ë‹ˆ, ì•„ë˜ì™€ ê°™ì€ ì—ëŸ¬ ë©”ì„¸ì§€ê°€ ë‚˜íƒ€ë‚¬ë‹¤.

ì‘ì—… í™˜ê²½ì€ Unity 2022 ì´ë‹¤.

<center>
<img src="{{img_url}}/img_0.png" style="width:1284px">
<figcaption style="margin-top:-20px;">ì—ëŸ¬ ë°œìƒ</figcaption>
</center>

valueê°€ nullì´ë¼ê³ ? ì´ê²Œ ë­ì§€??

ì´ Exceptionì´ ì°¸ ë‚œê°í–ˆë˜ ì´ìœ ëŠ”,

`Windows ì—ë””í„°`, `Mac ì—ë””í„°`, `Andorid` í™˜ê²½ì—ì„œëŠ” ë¬¸ì œê°€ ë°œìƒí•˜ì§€ ì•ŠëŠ”ë‹¤ëŠ” ê²ƒì´ë‹¤!

í”Œë«í¼ ë””íœë˜ì‹œí•œ ì½”ë“œê°€ ìˆë‹¤ë˜ê°€ í•˜ì§„ ì•Šì•„ì„œ ë‹¤ë¥¸ê±´ ì•„ë¬´ê²ƒë„ ì—†ëŠ”ë°, ì™œ ì•ˆë˜ëŠ” ê²ƒì´ì§€? ì¼ë‹¨ ì¡°ì‚¬í•´ë³´ê¸°ë¡œ í–ˆë‹¤. 

<center>
<img src="{{img_url}}/search.gif" style="width:320px">
<figcaption style="margin-top:-20px;">ì¡°ì‚¬ ì‹œì‘</figcaption>
</center>

ìì„¸í•œ ì—ëŸ¬ ë©”ì„¸ì§€ëŠ” ì•„ë˜ì™€ ê°™ë‹¤.

```
ArgumentNullException: Value cannot be null.
Parameter name: method
Newtonsoft.Json.Utilities.LateBoundReflectionDelegateFactory.CreateParameterizedConstructor (System.Reflection.MethodBase method) (at <00000000000000000000000000000000>:0)
Newtonsoft.Json.Serialization.JsonArrayContract.CreateWrapper (System.Object list) (at <00000000000000000000000000000000>:0)
Newtonsoft.Json.Serialization.JsonSerializerInternalReader.CreateList (Newtonsoft.Json.JsonReader reader, System.Type objectType, Newtonsoft.Json.Serialization.JsonContract contract, Newtonsoft.Json.Serialization.JsonProperty member, System.Object existingValue, System.String id) (at <00000000000000000000000000000000>:0)

... ì¤‘ëµ ...
```

ë„ëŒ€ì²´ ì™œ ì´ëŸ° ë¬¸ì œê°€ ë°œìƒí•˜ëŠ”ì§€ ì°¾ì•„ë³´ê¸° ìœ„í•´ ì½œ ìŠ¤íƒì„ ë¶„ì„í•´ë³´ì•˜ëŠ”ë°, 

`Newtonsoft.Json` ì—ì„œ ë¬¸ì œê°€ ë°œìƒí•œ ê²ƒìœ¼ë¡œ ë³´ì•„, ì§ë ¬í™”/ì—­ì§ë ¬í™” í•˜ëŠ” ê³¼ì •ì—ì„œ ì´ìŠˆê°€ ìƒê¸´ê²ƒìœ¼ë¡œ ë³´ì˜€ë‹¤.

ì•„ë˜ì™€ ê°™ì€ `GetUserData` ë©”ì„œë“œì—ì„œ ì—ëŸ¬ê°€ ë°œìƒí•˜ëŠ” ê²ƒì„ í™•ì¸í–ˆë‹¤.

```
... ì¤‘ëµ ...

Network.LocalServer.GetUserData (Network.Packets.RequestPacket packet) (at <00000000000000000000000000000000>:0)
Cysharp.Threading.Tasks.UniTaskCompletionSourceCore`1[TResult].TrySetResult (TResult result) (at <00000000000000000000000000000000>:0)

... ì¤‘ëµ ...
```

`GetUserData`ì—ì„œ Jsonê³¼ ê´€ë ¨ëœ ì½”ë“œëŠ” ì•„ë˜ ë°–ì— ì—†ì—ˆë‹¤..!

``` cs
var userProperty = JsonConvert.DeserializeObject<UserProperty>(json);
```

ì´ê²Œ ë„ëŒ€ì²´ ì™œ ë¬¸ì œê°€ ëœ ê²ƒì¼ê¹Œ? ì—´ì‹¬íˆ ë””ë²„ê¹… í•˜ëŠ” ì¤‘, 

`HashSet<string>` ì„ ì—­ì§ë ¬í™” í•˜ëŠ”ë° ë¬¸ì œê°€ ìˆìŒì„ ì•Œ ìˆ˜ ìˆì—ˆë‹¤.

<center>
<img src="{{img_url}}/img_1.png" style="width:754px">
<figcaption style="margin-top:-20px;">UserProperty í´ë˜ìŠ¤ì˜ ì¼ë¶€ ë‚´ìš©</figcaption>
</center>

í•´ë‹¹ ë‚´ìš©ì„ ì§€ìš°ê³  ë¹Œë“œë¥¼ í•´ í…ŒìŠ¤íŠ¸ë¥¼ í•˜ë©´, ì •ìƒì ìœ¼ë¡œ ë™ì‘í•˜ëŠ” ëª¨ìŠµì„ í™•ì¸ í•  ìˆ˜ ìˆì—ˆë‹¤.

<br><br>

---

# ğŸ”· í•´ê²° ë°©ë²•

ê´€ë ¨í•˜ì—¬ ë¹„ìŠ·í•œ ì´ìŠˆê°€ ìˆëŠ”ê±¸ í™•ì¸í–ˆë‹¤.

* [Unable to deserialize hashsets](https://discussions.unity.com/t/unable-to-deserialize-hashsets/807067)
* [JObject -> HashSet Exception on IOS](https://github.com/SaladLab/Json.Net.Unity3D/issues/8)

<br><br>

ë‹µë³€ì— ë”°ë¥´ë©´, ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ì½”ë“œë¥¼ ì œê±°í•˜ëŠ” [ë°”ì´íŠ¸ ì½”ë“œ ìŠ¤íŠ¸ë¦¬í•‘](https://docs.unity3d.com/kr/560/Manual/IL2CPP-BytecodeStripping.html) ë•Œë¬¸ì— ë°œìƒí•œ ë¬¸ì œë¼ê³  í•œë‹¤.

í•´ê²° ë°©ë²•ì€, ì„ì˜ì˜ ìœ„ì¹˜ì— í´ë”ë¥¼ í•˜ë‚˜ ë§Œë“¤ê³ , ì•„ë˜ì™€ ê°™ì€ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‘ì„±í•˜ëŠ” ê²ƒì´ë‹¤.

ë‚˜ì˜ ê²½ìš°ì—” `Scripts/Utils` ë¼ëŠ” í´ë”ì— `IOSSerializeHelper.cs` ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì¶”ê°€í–ˆë‹¤.

``` cs
using Newtonsoft.Json.Utilities;
using UnityEngine.Scripting;

namespace UserNameSpace  /* ë„¤ì„ìŠ¤í˜ì´ìŠ¤ë¥¼ ì œê±°í•´ë„ ë‹¹ì—°íˆ ë™ì‘í•œë‹¤. */
{
    public static class IOSSerializeHelper
    {
#if UNITY_IOS
        [Preserve]
        private static void FixSerialization()
        {
            AotHelper.EnsureList<string>();
            AotHelper.EnsureList<int>();
            AotHelper.EnsureList<float>();
            AotHelper.EnsureList<double>();
        }
#endif
    }
}
```

`[Preserve]` ë¼ëŠ” [ì–´íŠ¸ë¦¬ë·°íŠ¸](https://docs.unity3d.com/ScriptReference/Scripting.PreserveAttribute.html)ë¥¼ ì¶”ê°€í•´ì„œ, ë¹Œë“œì‹œ ì œê±°ë˜ì§€ ì•Šë„ë¡ í–ˆë‹¤.

íŠ¹ì§•ìœ¼ë¡œëŠ” ì € static ë©”ì„œë“œë¥¼ ì–´ë”˜ê°€ì—ì„œ í˜¸ì¶œí•˜ì§€ ì•Šì•„ë„, ê³ ì³ì§„ë‹¤ëŠ” ê²ƒì´ë‹¤.

<br>

ì¤‘ìš”í•œê²ƒì€, ë§Œì•½ ë³¸ì¸ì´ `HashSet<T>` ë¥¼ ì‚¬ìš©í•˜ê³  ìˆìœ¼ë©´,

`AotHelper.EnsureList<T>` ë¥¼ ì…ë ¥í•´ì£¼ì–´ì•¼ í•œë‹¤ê³  í•œë‹¤.

> ì˜ˆë¥¼ ë“¤ì–´, `HashSet<MyClass>` ë¥¼ ì—­ì§ë ¬í™” í•´ì•¼í•œë‹¤ë©´ 
> 
> `AotHelper.EnsureList<MyClass>` ë¥¼ ì¶”ê°€ë¡œ ì…ë ¥í•´ì•¼ í•œë‹¤ëŠ” ëœ»ì´ë‹¤.

<br>

í•´ë‹¹ ë‚´ìš©ì„ ì¶”ê°€í•˜ê³  ë¹Œë“œí•˜ë‹ˆ, ì •ìƒì ìœ¼ë¡œ ì˜ ë™ì‘í•˜ëŠ” ëª¨ìŠµì„ ë³¼ ìˆ˜ ìˆì—ˆë‹¤!