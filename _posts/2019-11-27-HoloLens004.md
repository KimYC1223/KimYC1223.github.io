---
layout: post
title:  NodeJS와 UDP소켓 통신 연결
tags: [HoloLens,Mixed Reality]
image: /img/post/MR/title004.png
bigimg: /img/nobgimage.png
comments: true
---

이번에 회사에서 진행하는 HoloLens to Driver Controller부분 구현과, 친한 동아리 선배와 함께 진행하는 프로젝트의 서버 부분 구현을 하게 되었는데, 이때 두 파트 동시에 Socket통신을 하도록 요구받았다. HoloLens의 경우 딱히 서버 플랫폼이 정해져 있지 않았는데, 선배와 같이 진행하는 프로젝트에서는 백엔드 플랫폼이 Node JS이므로 Node JS를 응용한 Socket 통신 서버를 구현하기로 하였다.

# Node JS에서의 Socket 통신

## 1 . TCP

### 사용 모듈

tcp socket 통신은 ```net```모듈을 사용한다.

### TCP SERVER

```
var net = require('net');
var server = net.createServer(function(socket) {
    // connection event
    console.log('클라이언트 접속');
    socket.write('Welcome to Socket Server');

    socket.on('data', function(chunk) {
        console.log('클라이언트가 보냄 : ',
        chunk.toString());
    });

    socket.on('end', function() {
        console.log('클라이언트 접속 종료');
    });
});

server.on('listening', function() {
    console.log('Server is listening');
});

server.on('close', function() {
    console.log('Server closed');
});

server.listen(3000);
```

### TCP CLIENT

```
var net = require('net');

var ip = '127.0.0.1';
var port = 3000;

var socket = new net.Socket();
socket.connect({host:ip, port:port}, function() {
   console.log('서버와 연결 성공');

   socket.write('Hello Socket Server\n');
   socket.end();

    socket.on('data', function(chunk) {
        console.log('서버가 보냄 : ',
        chunk.toString());        
    });

    socket.on('end', function() {
        console.log('서버 연결 종료');
    });
});
```

---

## 2 . UDP

### 사용 모듈

udp socket 통신은 ```dgram``` 모듈을 사용한다.

### UDP SERVER

```
var dgram = require('dgram');
var socket = dgram.createSocket('udp4');
socket.bind(3000);

socket.on('listening', function() {
    console.log('listening event');
});

socket.on('message', function(msg, rinfo) {
    console.log('메세지 도착', rinfo.address, msg.toString());
});

socket.on('close', function() {
    console.log('close event');
});
```

### UDP CLIENT

```
var dgram = require('dgram');
var socket = dgram.createSocket('udp4');

var msg = new Buffer('Hello UDP Receiver');
socket.send(msg, 0, msg.length, 3000, '127.0.0.1',
    function(err) {
        console.log(err);
        if ( err ) {
            console.log('UDP message send error', err);
            return;
        }
        console.log('메세지 전송 성공');
        socket.close();        
    }
);
```

<br>

---

# HoloLens 적용 사례

이번 MR 프로젝트에서는 HoloLens MR HMD 사용자가 산업용 Application 내에서

드라이버 동기화 모듈을 조작 할수 있고, 해당 모듈의 Master와 Slave간의

Time Offset(ns)를 알 수 있어야 하는 기능이 필요했다.

이때, 모듈의 Master는 드라이버를 조작할 수 있는 명령이나 오프셋을

UDP 소켓 인터페이스를 통해 외부와 소통하기 때문에

해당 모듈이 HoloLens사용자와 같은 AP에 속해있다면,

HoloLens와 모듈간의 소켓통신으로 해당 기능을 구현할 수 있다.

// 이미지

하지만, 2018년 8월 쯤 실시간 화상통화를 위해 HoloLens의 소켓 통신에 대한 자료를 찾아보던 중

Unity 3D 엔진 기반 UDP 서버를 만들어보았지만 패킷만 받으면 해당 App이 멈춰버렸다.

구글, Windows HoloLens 포럼등 다양한 곳에 검색해본 결과,

HoloLens 자체 방화벽에서 포트가 막혀있기 때문에 소켓 통신을 할 수 없다는 이슈를 찾을 수 있었다.

//링크
